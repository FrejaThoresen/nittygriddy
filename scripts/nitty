from datetime import datetime
from glob import glob
from pprint import pprint
import subprocess
import argparse
import os
import shutil
import sys

from nittygriddy import utils, settings


class formatter_class(argparse.ArgumentDefaultsHelpFormatter,
                      argparse.RawTextHelpFormatter):
    pass

parser = argparse.ArgumentParser(formatter_class=formatter_class)
parser.add_argument(
    '-v', '--verbose', action='store_true', default=False)
subparsers = parser.add_subparsers()


def datasets(args):
    if args.list:
        pprint(utils.get_datasets())
    elif args.search:
        pprint(utils.get_datasets().get(args.search, "Dataset not found."))
    elif args.download:
        if not args.volume:
            raise ValueError("No download volume specified")
        utils.download(args.download, args.volume)


parser_datasets = subparsers.add_parser('datasets')
parser_datasets.add_argument(
    '-l', '--list',
    help="list all predifined datasets", default=False, action='store_true')
parser_datasets.add_argument(
    '-s', '--search',
    help="search for dataset", type=str)
parser_datasets.add_argument(
    '-d', '--download',
    help="Download subset of specified dataset (see --volume)", type=str)
parser_datasets.add_argument(
    '--volume',
    help="Use with --download; Download this many GB", type=float)

parser_datasets.set_defaults(op=datasets)


def run(args):
    if not os.path.isfile(os.path.join(os.path.abspath(os.path.curdir), "nittygriddy.json"))\
       or not os.path.isfile(os.path.join(os.path.abspath(os.path.curdir), "ConfigureWagon.C")):
        print "Can only run from a nittygriddy project folder"
        return
    output_dir = os.path.join(os.path.abspath(os.path.curdir), datetime.now().strftime("%Y%m%d_%H%M"))
    if args.folder_postfix:
        output_dir += args.folder_postfix
    try:
        os.mkdir(output_dir)
    except OSError:
        print "Cannot create output folder {}".format(output_dir)
        return
    try:
        os.symlink(output_dir, "latest")
    except OSError as e:
        if os.path.islink("latest"):
            os.remove("latest")
            os.symlink(output_dir, "latest")
        else:
            raise e
    utils.copy_template_files_to(output_dir)
    shutil.copy(os.path.join(os.path.dirname(output_dir), "ConfigureWagon.C"), output_dir)
    # generate input file
    ds = utils.get_datasets()[args.dataset]
    # create GetSetting.C in output dir (from template)
    with open(os.path.join(output_dir, "GetSetting.C"), "w") as get_setting_c:
        as_string = utils.get_template_GetSetting().\
            format(overwrite_oadb_period=ds.get("overwrite_oadb_period", ""),
                   workdir=os.path.split(output_dir)[1],
                   datadir=ds['datadir'],
                   data_pattern=ds['data_pattern'],
                   run_number_prefix=ds['run_number_prefix'],
                   run_list=ds['run_list'],
                   is_mc=ds["is_mc"],
                   datatype=ds["datatype"],
                   runmode=args.runmode)
        get_setting_c.write(as_string)

    # start the analysis
    os.chdir(output_dir)
    if args.runmode != "grid":
        # create list of local files
        with open(os.path.join(output_dir, "input_files.dat"), 'a') as input_files:
            search_string = os.path.expanduser(os.path.join(settings["local_data_dir"],
                                                            ds["datadir"].lstrip("/"),
                                                            "*",
                                                            ds["data_pattern"]))
            input_files.write('\n'.join(glob(search_string)) + '\n')
        # command to start the analysis
        cmd = ['root', '-l', '-q', 'run.C']
    else:
        cmd = ['root', '-l', '-q', '-x', 'run.C(\"full\")']
    p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    for line in iter(p.stdout.readline, b''):
        print(line.rstrip())  # rstrip to remove \n; doesn't like carriage returns

description_run = """Start analysis on target platform. Must be executed from a
nittygriddy project folder (ie. next to a nittygriddy.json file)"""
parser_run = subparsers.add_parser('run', description=description_run)
parser_run.add_argument('runmode', choices=('local', 'lite', 'grid'))
parser_run.add_argument('dataset', type=str, help="Use this dataset")
parser_run.add_argument('--folder-postfix', type=str,
                        help="Attach to the end of the folder name")
parser_run.set_defaults(op=run)


args = parser.parse_args()
try:
    args.op(args)
except KeyboardInterrupt:
    sys.exit(1)
